name: CI/CD

on:
  push:
    branches:
      - "**"
    tags:
      - "*"
  pull_request:
  release:
    types:
      - published
  workflow_dispatch:

permissions:
  contents: read

env:
  JAVA_VERSION: "17"
  OPENAPI_GENERATOR_VERSION: "7.19.0"

jobs:
  validate-openapi:
    name: Validate OpenAPI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: Validate OpenAPI specs
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          specs=(openapi/*.yaml openapi/*.yml)
          if [ ${#specs[@]} -eq 0 ]; then
            echo "No OpenAPI specs found in openapi/"
            exit 1
          fi
          for spec in "${specs[@]}"; do
            echo "Validating $spec"
            mvn -q -DskipTests \
              org.openapitools:openapi-generator-maven-plugin:${OPENAPI_GENERATOR_VERSION}:validate \
              -DinputSpec="$spec"
          done

  generate-main:
    name: Generate APIs (main)
    runs-on: ubuntu-latest
    needs: validate-openapi
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: Generate Spring Boot + Axios
        run: mvn -q -DskipTests clean compile -P backend-spring,frontend-axios

  publish-release:
    name: Publish Packages
    runs-on: ubuntu-latest
    needs: validate-openapi
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'release'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve tag version
        id: version
        shell: bash
        run: |
          if [ "${GITHUB_EVENT_NAME}" = "release" ]; then
            TAG_NAME="${{ github.event.release.tag_name }}"
          else
            TAG_NAME="${GITHUB_REF_NAME}"
          fi
          VERSION="${TAG_NAME#v}"
          echo "tag=${TAG_NAME}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          server-id: github
          server-username: GITHUB_ACTOR
          server-password: GITHUB_TOKEN

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: https://npm.pkg.github.com

      - name: Generate Spring Boot + Axios (release)
        run: mvn -q -DskipTests clean compile -P backend-spring,frontend-axios -Drevision=${{ steps.version.outputs.version }}

      - name: Publish Spring Boot (Maven)
        run: mvn -q -DskipTests -f target/spring-boot-server/pom.xml deploy \
          -DaltDeploymentRepository=github::default::https://maven.pkg.github.com/${{ github.repository }}

      - name: Configure npm auth
        shell: bash
        run: |
          echo "@tcraft:registry=https://npm.pkg.github.com" > ~/.npmrc
          echo "//npm.pkg.github.com/:_authToken=${NODE_AUTH_TOKEN}" >> ~/.npmrc
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish Axios (npm)
        run: npm publish
        working-directory: target/typescript-axios-client
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
